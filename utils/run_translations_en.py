import sys

from transformers import pipeline
from transformers import FSMTForConditionalGeneration, FSMTTokenizer

mname = "wmt19-de-en"
tokenizer = FSMTTokenizer.from_pretrained(mname)
model = FSMTForConditionalGeneration.from_pretrained(mname)

translator = pipeline(task="translation", model=model, tokenizer=tokenizer, device=0)

def chunk(l, n):
    for i in range(0, len(l), n):
        yield l[i:i + n]

with open(sys.argv[1], 'r') as infile, open(sys.argv[1]+'.deen.en', 'w') as outfile:
    for batch in chunk(infile.readlines(), 100):
        decoded = translator(batch, batch_size=150)
        for line in decoded:
            outfile.write(line['translation_text']+'\n')
