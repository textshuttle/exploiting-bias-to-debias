#!/bin/bash

# Set variables
PATH_TO_VIRTUAL_ENVIRONMENT=$1
DATA_FOLDER=$2
OUTPUT_FOLDER=$3
LANG=$4                         # "de" or "en" or "en-fw"
CREATION_TYPE=$5                # "rule-based" or "round-trip"
FILETYPE=$6                     # "jsonl" for OSCAR files, "json" for LM outputs, "txt" for .txt files


# Create parallel training data
mkdir -p $OUTPUT_FOLDER

source $PATH_TO_VIRTUAL_ENVIRONMENT/bin/activate

if [ "$CREATION_TYPE" = "rule-based" ]; then
    echo "Creating parallel data with rules."
    for filepath in $DATA_FOLDER/*
        do filename=$(basename $filepath)
        gfr-prepare -i $filepath -o $OUTPUT_FOLDER/$filename -d data/${LANG}_seeds.json -l $LANG -f $FILETYPE -a $CREATION_TYPE
    done

elif [ "$CREATION_TYPE" = "round-trip" ]; then
    echo "Creating parallel data with round-trip translations."
    for filepath in $DATA_FOLDER/*
        do filename=$(basename $filepath)
        gfr-prepare -i $filepath -o $OUTPUT_FOLDER/$filename -d data/${LANG}_seeds.json -l $LANG -f $FILETYPE -a $CREATION_TYPE
        bash utils/translate.sh $OUTPUT_FOLDER/$filename.gf.trg $LANG
        gfr-merge -i $OUTPUT_FOLDER/$filename.gf.trg -r $OUTPUT_FOLDER/$filename.gf.trg.rt.src -l $LANG -o $OUTPUT_FOLDER/$filename.gf.trg.rt.merged
        cat $OUTPUT_FOLDER/$filename.gf.trg.rt.merged >> $OUTPUT_FOLDER/$filename.gf.src
        cat $OUTPUT_FOLDER/$filename.gf.trg.rt.trg | gfr-normalize -l $LANG -d @@GFM@@ --disable_sentence_splitting > $OUTPUT_FOLDER/$filename.gf.trg.rt.trg.marked
        cat $OUTPUT_FOLDER/$filename.gf.trg.rt.trg.marked $OUTPUT_FOLDER/$filename.gf.trg.rt.trg.marked > $OUTPUT_FOLDER/$filename.gf.trg
        rm $OUTPUT_FOLDER/$filename.gf.trg.rt.*
    done

else
    echo "The data creation approach" $CREATION_TYPE "is not yet supported, please update this script."
    exit
fi

cat $OUTPUT_FOLDER/*.gf.src > train.gf.src
cat $OUTPUT_FOLDER/*.gf.trg > train.gf.trg
cat $OUTPUT_FOLDER/*ngf.src > train.ngf.src
cat $OUTPUT_FOLDER/*ngf.trg > train.ngf.trg

echo "Done. Finished creating parallel data."
